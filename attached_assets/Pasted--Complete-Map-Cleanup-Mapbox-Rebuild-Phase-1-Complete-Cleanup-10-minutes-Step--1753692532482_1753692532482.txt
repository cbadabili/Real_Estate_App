# üßπ Complete Map Cleanup & Mapbox Rebuild

## Phase 1: Complete Cleanup (10 minutes)

### Step 1: Remove All Conflicting Dependencies

**In Replit Shell, run these commands one by one:**

```bash
# Remove Google Maps libraries
npm uninstall google-maps-react
npm uninstall @react-google-maps/api
npm uninstall react-google-maps
npm uninstall googlemaps

# Remove OpenStreetMap/Leaflet libraries
npm uninstall react-leaflet
npm uninstall leaflet
npm uninstall ol
npm uninstall openlayers

# Remove any other map libraries
npm uninstall maplibre-gl
npm uninstall deck.gl

# Clean npm cache
npm cache clean --force

# Verify clean state
npm list | grep -i map
```

### Step 2: Clean Environment Variables

**In Replit ‚Üí Tools ‚Üí Secrets, remove:**
- `GOOGLE_MAPS_API_KEY`
- `REACT_APP_GOOGLE_MAPS_API_KEY`
- `GOOGLE_MAPS_KEY`
- Any other Google Maps related keys

**Keep only these (we'll set them up):**
- `REACT_APP_MAPBOX_ACCESS_TOKEN` (to be added)

### Step 3: Remove Old Map Components

**Use Replit file explorer to delete these files if they exist:**
- `client/src/components/InteractiveMap.tsx`
- `client/src/components/properties/TestPropertyMap.tsx`
- `client/src/pages/TestMapPage.tsx`
- `client/src/components/MapView.tsx`
- `client/src/components/Map.tsx`
- Any other map-related components except PropertyMap.tsx

### Step 4: Clean Import Statements

**Use Replit global search (Ctrl+Shift+F) to find and remove these imports:**

**Search for and delete:**
```typescript
import GoogleMapReact from 'google-map-react';
import { GoogleMap, Marker } from '@react-google-maps/api';
import { MapContainer, TileLayer, Marker } from 'react-leaflet';
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';
```

**Search for files containing:** `'google'`, `'leaflet'`, `'GoogleMap'`

---

## Phase 2: Set Up Clean Mapbox (5 minutes)

### Step 1: Install Only Mapbox

```bash
# Install Mapbox GL JS (latest stable version)
npm install mapbox-gl@^3.0.0

# Install TypeScript types
npm install @types/mapbox-gl --save-dev

# Verify installation
npm list mapbox-gl
```

### Step 2: Get Mapbox API Token

**Go to [mapbox.com](https://mapbox.com):**
1. Sign up for free account
2. Go to **Account** ‚Üí **Access Tokens**
3. Copy your **Default Public Token** (starts with `pk.`)
4. Note: This token is free for up to 50,000 map loads/month

### Step 3: Add Token to Replit

**In Replit ‚Üí Tools ‚Üí Secrets:**
- **Key:** `REACT_APP_MAPBOX_ACCESS_TOKEN`
- **Value:** `pk.your_actual_token_here`

### Step 4: Verify Setup

**Create a test file to verify Mapbox works:**

**Create:** `client/src/components/MapTest.tsx`
```typescript
import React from 'react';
import mapboxgl from 'mapbox-gl';

export const MapTest = () => {
  const token = process.env.REACT_APP_MAPBOX_ACCESS_TOKEN;
  
  return (
    <div style={{ padding: '20px' }}>
      <h3>Mapbox Setup Test</h3>
      <p>Token exists: {token ? '‚úÖ Yes' : '‚ùå No'}</p>
      <p>Mapbox version: {mapboxgl.version}</p>
    </div>
  );
};
```

---

## Phase 3: Build Clean Map Component (10 minutes)

### Step 1: Replace PropertyMap.tsx Completely

**Replace entire content of `client/src/components/properties/PropertyMap.tsx`:**

```typescript
import React, { useEffect, useRef, useState } from 'react';
import mapboxgl from 'mapbox-gl';
import 'mapbox-gl/dist/mapbox-gl.css';

// Initialize Mapbox with your token
mapboxgl.accessToken = process.env.REACT_APP_MAPBOX_ACCESS_TOKEN || '';

interface Property {
  id: number;
  title: string;
  latitude?: number;
  longitude?: number;
  price: number;
  propertyType: string;
  address?: string;
}

interface PropertyMapProps {
  properties: Property[];
  height?: string;
}

export const PropertyMap: React.FC<PropertyMapProps> = ({ 
  properties = [], 
  height = '500px' 
}) => {
  const mapContainer = useRef<HTMLDivElement>(null);
  const map = useRef<mapboxgl.Map | null>(null);
  const [isLoaded, setIsLoaded] = useState(false);

  console.log('üó∫Ô∏è PropertyMap rendering with properties:', properties.length);

  // Initialize map once
  useEffect(() => {
    if (!mapContainer.current || map.current) return;

    console.log('üöÄ Initializing new Mapbox map');

    try {
      map.current = new mapboxgl.Map({
        container: mapContainer.current,
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [25.9231, -24.6282], // Gaborone [longitude, latitude]
        zoom: 11,
        attributionControl: true
      });

      // Add navigation controls
      map.current.addControl(new mapboxgl.NavigationControl(), 'top-right');

      // Map loaded event
      map.current.on('load', () => {
        console.log('‚úÖ Mapbox map loaded successfully');
        setIsLoaded(true);
      });

      // Error handling
      map.current.on('error', (e) => {
        console.error('‚ùå Mapbox error:', e.error);
      });

    } catch (error) {
      console.error('‚ùå Failed to initialize map:', error);
    }

    // Cleanup function
    return () => {
      if (map.current) {
        console.log('üßπ Cleaning up map');
        map.current.remove();
        map.current = null;
      }
    };
  }, []);

  // Add markers when map is loaded and properties change
  useEffect(() => {
    if (!map.current || !isLoaded || !properties.length) {
      console.log('‚è∏Ô∏è Skipping markers:', { mapExists: !!map.current, isLoaded, propCount: properties.length });
      return;
    }

    console.log('üìç Adding markers for', properties.length, 'properties');

    // Clear existing markers
    const existingMarkers = document.querySelectorAll('.mapboxgl-marker');
    existingMarkers.forEach(marker => marker.remove());

    // Sample coordinates around Gaborone for properties without coordinates
    const sampleCoords = [
      [25.9231, -24.6282], // Central Gaborone
      [25.9100, -24.6400], // West Gaborone  
      [25.8900, -24.6200]  // South Gaborone
    ];

    properties.forEach((property, index) => {
      // Use property coordinates or fallback to sample coordinates
      const lng = property.longitude || sampleCoords[index % sampleCoords.length][0];
      const lat = property.latitude || sampleCoords[index % sampleCoords.length][1];

      console.log(`üìå Creating marker for "${property.title}" at [${lng}, ${lat}]`);

      // Create popup content
      const popupContent = `
        <div style="padding: 10px; font-family: system-ui;">
          <h3 style="margin: 0 0 8px 0; font-size: 16px;">${property.title}</h3>
          <p style="margin: 0 0 5px 0; color: #666; font-size: 14px;">
            üìç ${property.address || 'Gaborone, Botswana'}
          </p>
          <p style="margin: 0; font-weight: bold; color: #007bff; font-size: 16px;">
            üí∞ P${property.price.toLocaleString()}
          </p>
          <div style="margin-top: 8px; font-size: 12px; color: #888;">
            Type: ${property.propertyType}
          </div>
        </div>
      `;

      // Create marker
      const marker = new mapboxgl.Marker({
        color: getPropertyColor(property.propertyType)
      })
        .setLngLat([lng, lat])
        .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(popupContent))
        .addTo(map.current!);

      console.log('‚úÖ Marker added successfully');
    });

    // Fit map to show all properties
    if (properties.length > 1) {
      const bounds = new mapboxgl.LngLatBounds();
      
      properties.forEach((property, index) => {
        const lng = property.longitude || sampleCoords[index % sampleCoords.length][0];
        const lat = property.latitude || sampleCoords[index % sampleCoords.length][1];
        bounds.extend([lng, lat]);
      });

      map.current!.fitBounds(bounds, { 
        padding: 50,
        maxZoom: 15 
      });

      console.log('üéØ Map fitted to show all properties');
    }

  }, [properties, isLoaded]);

  // Get color for property type
  const getPropertyColor = (type: string): string => {
    const colors = {
      house: '#28a745',      // Green
      apartment: '#007bff',  // Blue
      land_plot: '#fd7e14',  // Orange
      farm: '#6f42c1',       // Purple
      commercial: '#dc3545'  // Red
    };
    return colors[type.toLowerCase() as keyof typeof colors] || '#6c757d';
  };

  // Error state - no token
  if (!mapboxgl.accessToken) {
    return (
      <div style={{
        height,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        background: '#f8f9fa',
        border: '2px dashed #dee2e6',
        borderRadius: '8px'
      }}>
        <div style={{ textAlign: 'center', color: '#6c757d' }}>
          <h3>‚ö†Ô∏è Mapbox Token Missing</h3>
          <p>Add REACT_APP_MAPBOX_ACCESS_TOKEN to Replit Secrets</p>
        </div>
      </div>
    );
  }

  return (
    <div style={{ 
      width: '100%', 
      height,
      position: 'relative',
      border: '1px solid #dee2e6',
      borderRadius: '8px',
      overflow: 'hidden'
    }}>
      {/* Map container */}
      <div ref={mapContainer} style={{ width: '100%', height: '100%' }} />
      
      {/* Status overlay */}
      <div style={{
        position: 'absolute',
        top: '10px',
        left: '10px',
        background: 'rgba(255, 255, 255, 0.9)',
        padding: '8px 12px',
        borderRadius: '4px',
        fontSize: '12px',
        fontWeight: 'bold',
        boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
      }}>
        üè† {properties.length} properties ‚Ä¢ {isLoaded ? '‚úÖ Loaded' : '‚è≥ Loading...'}
      </div>
    </div>
  );
};

export default PropertyMap;
```

---

## Phase 4: Test & Verify (5 minutes)

### Step 1: Restart Replit App

```bash
# Stop current app (Ctrl+C)
# Then restart
npm start
```

### Step 2: Test Map Component

**Navigate to your Property Map Search page**

**Expected Results:**
- ‚úÖ Clean Mapbox map loads (no errors)
- ‚úÖ Shows "3 properties ‚Ä¢ ‚úÖ Loaded" in top-left
- ‚úÖ Three colored markers visible on Gaborone map
- ‚úÖ Markers clickable with property details
- ‚úÖ Browser console shows successful loading logs

### Step 3: Verify Console Logs

**Press F12 ‚Üí Console, look for:**
```
üó∫Ô∏è PropertyMap rendering with properties: 3
üöÄ Initializing new Mapbox map
‚úÖ Mapbox map loaded successfully
üìç Adding markers for 3 properties
üìå Creating marker for "three bed house" at [25.9231, -24.6282]
‚úÖ Marker added successfully
üéØ Map fitted to show all properties
```

### Step 4: Add Real Coordinates (Optional)

**If you want accurate positioning, run in Database tab:**
```sql
UPDATE properties SET latitude = -24.6282, longitude = 25.9231 WHERE id = 1;
UPDATE properties SET latitude = -24.6400, longitude = 25.9100 WHERE id = 2;  
UPDATE properties SET latitude = -24.6200, longitude = 25.8900 WHERE id = 3;
```

---

## ‚úÖ Success Criteria

**After completing all phases:**

### Technical Success:
- [ ] No map-related errors in console
- [ ] Only mapbox-gl in package.json dependencies  
- [ ] Clean PropertyMap component working
- [ ] Three properties visible as markers
- [ ] Markers clickable with property details

### Visual Success:
- [ ] Professional-looking map interface
- [ ] Smooth zoom and pan interactions
- [ ] Color-coded property markers
- [ ] Responsive design (works on mobile)
- [ ] Loading states and error handling

### Business Success:
- [ ] Users can discover properties on map
- [ ] Property information easily accessible
- [ ] Fast loading and smooth performance
- [ ] Foundation ready for advanced features

---

## üö® Troubleshooting

**Problem:** Map doesn't load
**Check:** Browser console for token errors, verify Replit Secrets

**Problem:** No markers show  
**Check:** Console logs for property data, database coordinates

**Problem:** Markers in wrong location
**Check:** Coordinate order (should be [longitude, latitude])

**Problem:** Build errors
**Check:** All old map imports removed, only mapbox-gl installed

**Ready to start Phase 1 cleanup?** üßπ